#!/usr/bin/env python3
"""
Pi Fan
"""

import argparse
from mylib import PiFanController, IpmiCpu, IpmiFan

def parse_args():
    """
    Parse command line arguments.
    Return arguments.
    """
    parser = argparse.ArgumentParser(
        description='Dell PowerEdge fan speed controller for Raspberry Pi.',
        epilog=""
    )
    parser.add_argument('--interval', type=int, metavar='SEC', default=10,
                        help='Delay between polls')
    parser.add_argument('--idealtemp', type=float, metavar='DEG_C', default=40,
                        help='Ideal temperature (default: 40)')
    parser.add_argument('--maxtemp', type=float, metavar='DEG_C', default=75,
                        help='Max allowable temperature (default: 75)')
    parser.add_argument('--easing', metavar='TYPE', default='parabolic',
                        choices=['linear', 'parabolic'],
                        help='Fan speed easing type: linear | parabolic (default: parabolic)')
    parser.add_argument('--dry-run', const=True, default=False, action='store_const',
                        help='Dry run: don\'t change server settings')
    parser.add_argument('host', metavar='HOST', help='Target host')
    parser.add_argument('username', metavar='USERNAME', help='Username')
    parser.add_argument('password', metavar='PASSWORD', help='Password')

    return parser.parse_args()

def main():
    """
    Program entrypoint.
    """
    args = parse_args()

    ipmi_fan = IpmiFan(args.host, args.username, args.password)
    ipmi_fan.discover_sensors()
    ipmi_cpu = IpmiCpu(args.host, args.username, args.password)
    ipmi_cpu.discover_sensors()

    controller = PiFanController(ipmi_fan, ipmi_cpu)
    controller.interval = args.interval
    controller.ideal_temp = args.idealtemp
    controller.max_temp = args.maxtemp
    controller.easing = args.easing
    controller.dry_run = args.dry_run
    controller.monitor()

if __name__ == '__main__':
    main()
